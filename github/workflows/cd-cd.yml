name : CI-CD

on:
  push:
    branches:
      - master

  jobs:
    build-and-deploy:
      runs-on : ubuntu-latest

      steps:
        # checkout the code
        - uses : actions/checkout@v3
        - uses: actions/setup-java@v3
          with:
            distribution: temurin
            java-version: '17'

        # Build the Spring Boot JAR
        - name: Build JAR
          run: mvn clean package -DskipTests

        - uses : azure/login@v1
          with :
            creds : ${{ secrets.AZURE_CREDENTIALS}}

        # Build the Docker image:
        - name: Build Docker image
          run: |
            docker build -t testregistrysamid.azurecr.io/testapp:${{ github.sha }} .

        # log in to ACR
        - name: Log in to ACR
          run: |
            echo ${{ secrets.ACR_PASSWORD }} | docker login 
            

        # Deploy to Azure Container Instance
        - name: Deploy to ACI
          run: |
            az container create --resource-group samidGroup --name testregistrysamid --image testregistrysamid.azurecr.io/testapp:${{ github.sha }}
